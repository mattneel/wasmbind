# Generated Code

wasmbind produces two artifacts:

1. `exports.zig` – the Zig file compiled into your WASM artifact.
2. `bindings.ts` – TypeScript wrapper classes + helpers.

## Zig Output Overview

```zig
// Auto-generated by wasmbind - DO NOT EDIT
const std = @import("std");
const wasm_contract = @import("wasm_contract");
const wasm_exports = wasm_contract.exports;
const allocator = std.heap.wasm_allocator;
```

For each exported struct `Foo`:

```zig
const Foo_Type = wasm_exports.Foo;
var Foo_instances: std.ArrayListUnmanaged(*Foo_Type) = .{};
var Foo_next_id: u32 = 0;
```

### Init Function

```zig
export fn Foo_init(arg0: u32) u32 { ... }
```

- Allocates with `allocator.create(Foo_Type)`.
- Calls `Foo_Type.init(...)`.
- Stores pointer in `Foo_instances` and returns a handle.

### Regular Methods

```zig
export fn Foo_resize(id: u32, width: u32, height: u32) void { ... }
```

- Validates the handle.
- Reconstructs slices where necessary.
- Calls the user method.

### Slice Returns

Two helper exports per slice-returning method:

```zig
export fn Foo_render_ptr(id: u32) usize { ... }
export fn Foo_render_len(id: u32) usize { ... }
```

### Lifecycle

```zig
export fn __wasmbind_init() void { ... }
export fn __wasmbind_deinit() void { ... }
export fn allocate(size: usize) usize { ... }
export fn deallocate(ptr: usize, size: usize) void { ... }
```

## TypeScript Output Overview

```ts
export class Foo {
  private wasm: WebAssembly.Instance;
  private memory: WebAssembly.Memory;
  private id: number;

  constructor(wasm: WebAssembly.Instance, ...args) { ... }
  resize(width: number, height: number): void { ... }
  render(): Uint8Array { ... }
  destroy(): void { ... }
}
```

### Constructor

1. Captures the `WebAssembly.Instance`.
2. Stores `memory` for typed array views.
3. Calls the exported `Foo_init` and saves the returned handle.

### Method Calls

Every method does:

- `this.ensureInstance()` (throws if module not initialized).
- Encodes parameters (strings, slices).
- Calls the WASM export via cached function pointer.
- Decodes results (numbers, BigInts, typed arrays).

### Memory Helpers

```ts
private marshalString(value: string): [number, number]
private marshalArray(view: ArrayBufferView): [number, number]
```

They allocate via exported `allocate`, copy data into WASM memory, and return `[ptr, len]`. `finally` blocks ensure `deallocate` runs even if the WASM call throws.

### loadWasm Helper

```ts
export async function loadWasm(source: string | URL | ArrayBuffer | Response, imports = {}): Promise<WebAssembly.Instance>
```

- Accepts URL/Request/Buffer.
- Fetches/instantiates the module.
- Injects default `env` imports (if any).
- Calls `__wasmbind_init()`.
- Returns the WebAssembly instance.

### Standalone Functions

```ts
export function format(value: number): string { ... }
```

Generated when `pub const exports` contains function values.

## Customizing Output

- Extend the TypeScript generator (see `src/codegen_ts.zig`) to emit additional helpers.
- Post-process `bindings.ts` with your bundler (esbuild/Vite) to add runtime checks or polyfills.
- Use the `module_name` option (future) to customize the exported namespace.

Understanding the generated code makes debugging easier and opens the door to advanced customization.
