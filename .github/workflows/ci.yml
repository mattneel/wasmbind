name: CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 0 * * *'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: jdx/mise-action@v2
      - name: Check formatting
        run: zig fmt --check .

  test:
    name: Test (${{ matrix.os }} / ${{ matrix.optimize }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            optimize: Debug
          - os: ubuntu-latest
            optimize: ReleaseFast
          - os: windows-latest
            optimize: Debug
          - os: windows-latest
            optimize: ReleaseFast
          - os: macos-latest
            optimize: Debug
          - os: macos-latest
            optimize: ReleaseFast
    steps:
      - uses: actions/checkout@v5
      - uses: jdx/mise-action@v2
      - name: Run tests
        run: zig build test -Doptimize=${{ matrix.optimize }} --summary all

  examples:
    name: Examples / ${{ matrix.example }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example: [chart-demo]
    steps:
      - uses: actions/checkout@v5
      - uses: jdx/mise-action@v2
      - name: Build example (Zig)
        working-directory: examples/${{ matrix.example }}
        run: zig build
      - name: Test example (Zig)
        working-directory: examples/${{ matrix.example }}
        run: zig build test
      - name: Install TypeScript deps
        run: mise run ts-install-chart-demo
      - name: Type-check TypeScript
        run: mise run ts-check-chart-demo
      - name: Build TypeScript
        run: mise run ts-build-chart-demo
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.example }}-artifacts
          path: |
            examples/${{ matrix.example }}/zig-out/
            examples/${{ matrix.example }}/www/generated/

  wasm-validate:
    name: Validate WASM
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v5
      - uses: jdx/mise-action@v2
      - name: Install WABT
        run: |
          sudo apt-get update
          sudo apt-get install -y wabt
      - name: Build examples
        run: |
          cd examples/chart-demo
          zig build
      - name: Validate modules
        working-directory: examples/chart-demo
        run: |
          shopt -s nullglob
          for wasm in zig-out/lib/*.wasm; do
            echo "Validating $wasm"
            wasm-validate "$wasm"
            wasm-objdump -x "$wasm" | head -n 40
          done
      - name: Enforce size budget
        working-directory: examples/chart-demo
        run: |
          shopt -s nullglob
          for wasm in zig-out/lib/*.wasm; do
            size=$(wc -c < "$wasm")
            echo "$wasm: $size bytes"
            if [ $size -gt 1048576 ]; then
              echo "ERROR: $wasm exceeds 1MB budget"
              exit 1
            fi
          done

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: jdx/mise-action@v2
      - name: Run tests with coverage
        run: zig build test -Dtest-coverage || true
      - name: Coverage placeholder
        run: echo "Coverage reporting coming soon"

  benchmark:
    name: Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v5
      - uses: jdx/mise-action@v2
      - name: Run benchmarks
        run: zig build bench || echo "Benchmarks not configured"
